<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">
<head>
    <meta charset="UTF-8">
    <title>所有商品</title>
    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/pure-min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        .product-container {
            max-width: 800px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 20px;
        }

        .product-card {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .product-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .product-price {
            font-size: 18px;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .add-to-cart {
            display: inline-block;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .add-to-cart:hover {
            background-color: #45a049;
        }

    </style>
    <script th:inline="javascript">

      var userName = /*[[${#strings.escapeJavaScript(#authentication.principal.username)}]]*/ null;

      function addProduct() {
        var productName = window.prompt("請輸入商品名稱:");
        var productPrice = window.prompt("請輸入商品價格:");

        if (productName && productPrice) {
          // 創建JSON對象
          var productData = {
            productName: productName,
            productPrice: productPrice
          };

          // 使用AJAX發送POST請求
          fetch('/product/add', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(productData)
          }).then(response => {
            if (response.ok) {
              // 請求成功，進行相應的處理
              alert("商品新增成功！");
              location.reload(); // 重新載入頁面以顯示新增的商品
            } else {
              // 請求失敗，處理錯誤
              alert("商品新增失敗！");
            }
          }).catch(error => {
            // 請求錯誤，處理錯誤
            alert("商品新增發生錯誤！");
          });
        }
      }



      function editProduct(productId) {
        var productName = window.prompt("請輸入修改後的商品名稱:");
        var productPrice = window.prompt("請輸入修改後的商品價格:");

        if (productName && productPrice) {
          // 創建JSON對象
          var productData = {
            productName: productName,
            productPrice: productPrice
          };

          // 使用AJAX發送PUT請求
          fetch('/product/replace/' + productId, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(productData)
          }).then(response => {
            if (response.ok) {
              // 請求成功，進行相應的處理
              alert("商品修改成功！");
              location.reload(); // 重新載入頁面以顯示修改後的商品
            } else {
              // 請求失敗，處理錯誤
              alert("商品修改失敗！");
            }
          }).catch(error => {
            // 請求錯誤，處理錯誤
            alert("商品修改發生錯誤！");
          });
        }
      }

      function addToCart(productId) {

          var addToCartRequestDTO = {
            userName: userName,
            productId: productId,
            productQuantity : 1
          };

          // 使用AJAX發送POST請求
          fetch('/cart/add/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(addToCartRequestDTO)
          }).then(response => {
            if (response.ok) {
              // 請求成功，進行相應的處理
              alert("購物車新增成功！");
              location.reload(); // 重新載入頁面以顯示修改後的商品
            } else {
              // 請求失敗，處理錯誤
              alert("購物車新增失敗！");
            }
          }).catch(error => {
            // 請求錯誤，處理錯誤
            alert("購物車新增發生錯誤！");
          });
        }

        function viewCart() {
            if (userName) {
              window.location.href = '/cart/' + userName;
            } else {
              alert("請先登入以查看購物車！");
            }
          }


    </script>

</head>
<body>
<div class="logout-link">
    <a href="/logout">登出</a>
</div>
<div class="container">
    <div class="row justify-content-end mb-3">
        <div class="col-auto">
            <button type="button" class="btn btn-primary" onclick="addProduct()">新增商品</button>
            <button type="button" class="btn btn-primary" onclick="viewCart()">查看購物車</button>
            <form id="addProductForm" th:action="@{/product/add}" method="post" style="display: none;">
                <input type="hidden" name="productName" id="productName"/>
                <input type="hidden" name="productPrice" id="productPrice"/>
            </form>
        </div>
    </div>
    <div class="product-container">
        <!-- 使用 Thymeleaf 迴圈來動態生成商品 -->
        <div th:each="product : ${products}" class="product-card">
            <div class="product-name" th:text="${product.productName}"></div>
            <div class="product-price" th:text="${'$' + product.productPrice}"></div>
            <button class="add-to-cart" th:text="加入購物車" th:data-product-id="${product.id}" onclick="addToCart(this.getAttribute('data-product-id'))">加入購物車</button>

            <!-- 只有admin權限的用戶才能看到以下按鈕 -->
            <div sec:authorize="hasAuthority('admin')" class="d-flex justify-content-between">
                <button type="button" class="btn btn-warning me-2" th:data-product-id="${product.id}" onclick="editProduct(this.getAttribute('data-product-id'))">編輯</button>
                <form th:action="@{/product/delete/{id}(id=${product.id})}" method="post">
                    <input type="hidden" name="_method" value="DELETE"/>
                    <button type="submit" class="btn btn-danger">刪除</button>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
</html>
